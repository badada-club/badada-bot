Разработка
========================

Определения
------------------------
- "продакшн" - задеплоенный телеграм-бот, реально работающий в чате сообщества

Работа с Git
------------------------
В проекте используется [GitHub flow](https://docs.github.com/en/get-started/quickstart/github-flow).

В репозитории есть основная ветка master, код из которой работает в "продакшне". Для написания новой фичи надо сделать для нее branch и [разрабатывать](#разработка-новой-фичи) в нем. По готовности создать Pull Request в master и вмерджить после review и прогона тестов.

Переменные окружения
------------------------

Приложение конфигурируется посредством переменных окружения. Значение <значение_переменной_окружения> переменной окружения <имя_переменной_окружения> задается:
- при разработке - в файле .env: `<имя_переменной_окружения>=<значение_переменной_окружения>`
- на Heroku - выставляются отдельной командой
```
heroku config:set <имя_переменной_окружения>=<значение_переменной_окружения>
```

Разработка новой фичи
------------------------
1. Сделать новую ветку для фичи в локальном репозитории.

2. Сделать своего бота, на котором будет тестироваться разрабатываемый функционал. Для этого пообщаться с ботом [@BotFather](https://t.me/BotFather), задав при этом < username > бота, и получить от него <токен>. Прописать <токен> в переменную окружения TELEGRAM_API_TOKEN, < username > - в переменную окружения TELEGRAM_BOT_USERNAME.
3. Создать telegram-канал <название_канала_для_разработки>, имитирующий канал Badada Events. Прописать его id в переменную окружения BADADA_EVENTS_CHANNEL_ID.
4. Создать telegram-группу <название_группы_для_разработки>, имитирующую основной канал Badada Club. Прописать ее id в переменную окружения BADADA_CLUB_CHAT_ID.

5. Хостить приложение при разработке там же, где "продакшн" (в том же Heroku-аккаунте), запрещается для экономии бесплатных часов аптайма.

6. Прописать <url_приложения> в переменную окружения APP_URL. Если приложение хостится на Heroku, то URL будет иметь вид `https://<имя_приложения_heroku>.herokuapp.com`. К этому адресу приложение подключает WebHook, через который Telegram шлет сообщения боту.
7. Если фича касается регулярных заданий, то на cron-job.org надо создавать отдельный от "продакшна" cronjob.
8. Поставить Postgres локально. Создать там (пустую) базу <имя_базы> для приложения. Указать путь к ней в переменной окружения DATABASE_URL. Например
```
DATABASE_URL=postgresql://postgres:local_postgres@localhost:5432/<имя_базы>?schema=public
```
9. Создать базу:
```
npm run prisma:migrate:dev
```
12. По окончании разработки
    1. Поменять файлы *.md с документацией проекта в соответствии с изменениями.
    2. Пропушить ветку фичи на github и создать pull request из нее в master.
    3. Дать pull request на review другим разработчикам.
    4. Дождаться прогона тестов.
    5. Вмерджить в master.
    6. Опубликовать "продакшн" Heroku-приложение с изменениями.

Рекомендуемые extension'ы для VS Code
------------------------

1. ESLint

Рекомендуемые настройки для ESLint в settings.json:
```
"eslint.format.enable": true,
"eslint.lintTask.enable": true,
"editor.codeActionsOnSave": {
    "source.fixAll.eslint": true,
}
```
2. Prisma

Подсветка и проверка синтаксиса в *.prisma файлах - схемах для Prisma.

3. Jest

Отображение тестов списком, возможность прогона и дебага отдельного теста.


Внесение изменений в схему БД
------------------------
1. Поменять схему в .prisma файле.
2. Накатить изменения на БД:
```
npm run prisma:migrate:dev
```
Если новая схема конфликтует со старой, Prisma предложит потереть все в существующей базе.

Публикация
========================

Для "продакшна" предполагается создать Heroku-приложение в Heroku-аккаунте badada.it. Публикуемое на Heroku приложение имеет свое имя <имя_приложения_heroku>, свой Git-репозиторий, свой адрес в Интернете https://<имя приложения>.herokuapp.com.

Публикация на Heroku через git вкратце:

1. В корне локальной копии репозитория выполнить `heroku login`. В открывшемся в браузере окне вводим логин/пароль от аккаунта heroku.
2. Если приложение на Heroku еще не было создано, то
    1. Создать приложение: `heroku create <имя_приложения_heroku>`. Имя приложения для разработки можно выбрать любым.
    2. Создать базу: `heroku addons:create heroku-postgresql:hobby-dev`
3. Выставить переменные окружения (см. список в разделе [разработка новой фичи](#Разработка-новой-фичи)).
4. Сделать push локальной ветки, в которой ведется разработка, в ветку master удаленного репозитория Heroku-приложения на сервере Heroku. При создании Heroku-приложения такой удаленный репозиторий создается автоматически, но при необходимости его можно сделать и самому. Адрес Heroku-репозитория приложения можно посмотреть, например, в веб-интерфейсе Heroku.